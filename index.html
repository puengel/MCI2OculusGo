<html>
  <head>
    <script src="Assets/dist/aframe-master.min.js"></script>
    <script src="Assets/dist/aframe-environment-component.min.js"></script>
    <script src="Assets/src/components/oculus-go-controls.js"></script>
    <script>
      let checker = true;
      AFRAME.registerComponent("camera-movement", {
        init: function() {
          let self = this;
          let data = this.data;
          let el = this.el;
          this.data.moving = false;
          let moving = this.data.moving;

          let hands = document.querySelectorAll("[line]");
          let right = hands[1];

          console.log(right);
          // let line = right.components.line;
          // console.log(line);
          // this.player = right.components.line.line;

          this.player = AFRAME.scenes[0].querySelector(
            "[raycaster]"
          ).components.raycaster;
          console.log(this.player);

          let axes = [0, 0];
          this.touchOnly = true;

          el.addEventListener("trackpaddown", function(event) {
            // console.log("trackpad down");
            //console.log(this.moving);
            self.data.moving = true;

            // console.log(this.moving);
          });

          el.addEventListener("trackpadup", function(event) {
            // console.log("trackpad up");
            // console.log(event);
            self.data.moving = false;
          });

          // el.addEventListener("trackpadchanged", function(event) {
          //   console.log("trackpad changed");
          //   if (touchOnly){
          //     let pad = navigator.getGamepads().item(0);
          //     let newAxes = pad.axes;
          //     console.log(axes);
          //     console.log(newAxes);
          //   }
          // });

          // el.addEventListener("trackpadtouchstart", function(event, a, b, c, d){
          //   console.log("touchpad touch start");
          //   let pad = navigator.getGamepads().item(0);
          //   axes = pad.axes;
          //   touchOnly = true;
          // });

          // el.addEventListener("trackpadtouchend", function(event){
          //   console.log("touchpad touch end");
          //   if (touchOnly){
          //     let pad = navigator.getGamepads().item(0);
          //     let newAxes = pad.axes;
          //     console.log(axes);
          //     console.log(newAxes);
          //   }
          // });

          // // el.addEventListener("triggerchanged", function(event){
          // //   console.log("trigger changed");
          // //   console.log(event);
          // // });

          // el.addEventListener("trackpadmoved", function(event){
          //   console.log("moved");
          //   console.log(event);
          // });

          // el.addEventListener("triggerdown", function(event){
          //   console.log("trigger down");
          //   console.log(event);
          // });

          // el.addEventListener("triggerup", function(event){
          //   console.log("trigger up");
          //   console.log(event);
          // });
        },

        tick: function() {
          // console.log(this.data.moving);
          if (this.data.moving) {
            // console.log("moving");

            let hands = document.querySelectorAll("[raycaster]");
            let right = hands[1];
            let dir = right.object3D.getWorldDirection();
            let vec3d = new THREE.Vector3(dir.x, dir.y, dir.z);
            vec3d.normalize();

            // this.player = right.components.line.line;
            let wrapper = document.querySelector("#camera-wrapper");
            let pad = navigator.getGamepads().item(0);
            let axes = pad.axes;
            console.log(axes);
            let pos = wrapper.getAttribute("position");

            let vz = 0;
            let vx = 0;

            let deadzone = 0.3;

            if (axes[1] > deadzone) {
              vz = 1;
            }

            if (axes[1] < -deadzone) {
              vz = -1;
            }

            if (axes[0] > deadzone) {
              vx = 1;
            }

            if (axes[0] < -deadzone) {
              vx = -1;
            }

            pos.x -= vec3d.z * 0.1 * -vx - vec3d.x * 0.1 * vz;
            pos.z -= vec3d.x * 0.1 * vx + vec3d.z * 0.1 * -vz;

            // pos.x -= axes[0]>0.5 || axes[0]<-0.5 ? vec3d.x * 0.1 : 0;
            // pos.z -= axes[1]>0.5 || axes[1]<-0.5 ? vec3d.z * 0.1 : 0;
            wrapper.setAttribute("position", pos);
            this.touchOnly = false;
          }
        }
      });
    </script>
    <script>
      AFRAME.registerComponent("grabbableobject", {
        schema: {
          color: { default: "red" },
          trigger: { default: "green" },
          mouse: { default: "#ffffff" },
          out: { default: "#000000" }
        },

        init: function() {
          var data = this.data;
          var el = this.el; // <a-box>
          var defaultColor = el.getAttribute("material").color;

          el.addEventListener("mousedown", function() {
            el.setAttribute("grabbed", null);
          });

          el.addEventListener("mouseup", function() {
            el.removeAttribute("grabbed");
          });
        }
      });

      AFRAME.registerComponent("grabbed", {
        schema: {
          distance: { default: 1 }
        },

        init: function() {
          let el = this.el;
          let data = this.data;

          let hands = document.querySelectorAll("[raycaster]");
          let left = hands[0];
          let posRef = left.object3D.getWorldPosition();
          let posObj = el.getAttribute("position");
          let distance = Math.abs(
            Math.sqrt(
              Math.pow(posRef.x - posObj.x, 2) +
                Math.pow(posRef.y - posObj.y, 2) +
                Math.pow(posRef.z - posObj.z, 2)
            )
          );

          //let rot = left.object3D.getWorldDirection();

          //let rotNew = new THREE.Vector3(rot.x, rot.y, rot.z);
          //rotNew.normalize();
          //console.log(initPos);
          data.distance = distance;
          //console.log(el.getAttribute('position'));
          console.log(distance);
        },

        tick: function() {
          let el = this.el;
          let data = this.data;
          let sin = Math.sin;
          let cos = Math.cos;

          let hands = document.querySelectorAll("[raycaster]");
          let left = hands[0];

          let rot = left.object3D.getWorldDirection();
          //rot.y = rot.y * 2 * Math.PI;
          let posRef = left.object3D.getWorldPosition();
          console.log(data.distance);
          //console.log(cos(rot.y));

          //data.distance wird als 1 angesehen
          el.setAttribute("position", {
            x: posRef.x - rot.x * data.distance,
            y: posRef.y - rot.y * data.distance,
            z: posRef.z - rot.z * data.distance
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene>
      <a-entity id="camera-wrapper" position="0 0 0">
        <a-camera id="camera" position="0 2 0"></a-camera>

        <a-entity
          id="controller"
          camera-movement
          id="leftHand"
          laser-controls="hand: left"
          raycaster="objects: .collidable"
          line="color: #118A7E"
        ></a-entity>
        <a-entity
          camera-movement
          id="rightHand"
          laser-controls="hand: right"
          raycaster="objects: .collidable"
          line="color: #118A7E"
        ></a-entity>
      </a-entity>

      <a-entity environment="preset: forest; dressingAmount: 500"></a-entity>
      <a-box
        class="collidable"
        grabbableobject
        color="blue"
        position="0 2 -5"
        scale="2 2 2"
      ></a-box>
    </a-scene>
  </body>
</html>
